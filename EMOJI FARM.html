<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ—Ä–æ–π-–§–µ—Ä–º–µ—Ä: Optimized</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #2ecc71;
            font-family: 'Press Start 2P', cursive;
            color: white;
            user-select: none;
        }

        canvas { display: block; }

        /* UI */
        #ui-layer {
            position: absolute;
            top: 10px; left: 10px;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 320px;
            z-index: 5;
        }

        .hud-panel {
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid #fff;
            padding: 12px;
            border-radius: 10px;
            font-size: 10px;
            color: #fff;
            backdrop-filter: blur(4px);
        }

        .section-title {
            border-bottom: 2px solid #555;
            margin-bottom: 8px;
            padding-bottom: 4px;
            color: #f1c40f;
            text-align: center;
        }

        .inv-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 10px;
        }

        /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é */
        #main-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 200; color: white; text-align: center;
            backdrop-filter: blur(5px);
        }

        #main-menu h1 { font-size: 40px; color: #f1c40f; margin-bottom: 10px; text-shadow: 4px 4px 0 #d35400; }
        .menu-btn {
            padding: 15px 40px; font-size: 20px; background: #27ae60;
            border: none; border-bottom: 5px solid #1e8449; color: white;
            font-family: inherit; cursor: pointer; border-radius: 8px; margin-top: 20px;
        }
        .menu-btn:hover { filter: brightness(1.1); transform: translateY(-2px); }

        /* –ú–∞–≥–∞–∑–∏–Ω */
        #shop-modal {
            display: none;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #fff; border: 8px solid #2c3e50;
            color: #333; padding: 15px; width: 800px; height: 80vh;
            border-radius: 15px; z-index: 10;
            display: flex; flex-direction: column;
        }

        .shop-header { text-align: center; margin-bottom: 10px; font-size: 16px; }

        .shop-tabs { display: flex; gap: 5px; margin-bottom: 10px; flex-shrink: 0; }
        .shop-tab {
            flex: 1; background: #ecf0f1; border: none; padding: 10px;
            cursor: pointer; font-family: inherit; font-size: 10px;
            border-bottom: 4px solid #bdc3c7;
        }
        .shop-tab.active { background: #2c3e50; color: #fff; border-bottom: 4px solid #000; }

        #shop-scroll-area {
            flex: 1; overflow-y: auto; padding-right: 5px;
        }

        .shop-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
        }

        .shop-item {
            background: #fdfdfd; border: 1px solid #ccc;
            padding: 8px; text-align: center; font-size: 9px;
            border-radius: 6px; display: flex; flex-direction: column;
            justify-content: space-between; height: 140px;
        }

        .price-tag { color: #e74c3c; font-weight: bold; }
        .profit-tag { color: #27ae60; font-weight: bold; }

        .shop-btn {
            margin-top: auto; background: #27ae60; color: white;
            border: none; border-bottom: 3px solid #1e8449;
            padding: 6px; cursor: pointer; font-family: inherit; width: 100%; font-size: 8px;
        }
        .shop-btn:disabled { background: #95a5a6; border-color: #7f8c8d; cursor: not-allowed; }
        .sell-btn { background: #e67e22; border-color: #d35400; }

        .close-btn {
            background: #c0392b; color: white; border: none;
            border-bottom: 4px solid #922b21; padding: 10px;
            width: 100%; margin-top: 10px; cursor: pointer; font-family: inherit; flex-shrink: 0;
        }

        #message-area {
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
            font-size: 20px; font-weight: bold; text-shadow: 2px 2px 0 #000;
            pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 100;
        }

        #fps-meter {
            position: absolute; top: 5px; right: 5px; color: #0f0; font-size: 10px; pointer-events: none;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>
    <div id="fps-meter">FPS: 60</div>

    <!-- MENU -->
    <div id="main-menu">
        <h1>üåç –ì–ï–†–û–ô-–§–ï–†–ú–ï–†</h1>
        <h2 style="color:#2ecc71; font-size:14px;">TURBO EDITION ‚ö°</h2>
        <div style="font-size:10px; max-width: 600px; line-height:1.5; color:#ccc; margin-bottom:20px;">
            –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–û –î–õ–Ø FULLSCREEN.<br>
            –≠–∫–æ–Ω–æ–º–∏–∫–∞ –∂–∏–≤–∞—è, –º–∏—Ä –æ–≥—Ä–æ–º–Ω—ã–π.<br>
            –£–¥–∞—á–∏, —Ñ–µ—Ä–º–µ—Ä!
        </div>
        <button class="menu-btn" onclick="game.startGame()">–ù–ê–ß–ê–¢–¨</button>
    </div>

    <!-- UI -->
    <div id="ui-layer">
        <div class="hud-panel">
            <div class="inv-row"><span style="font-size:14px">üí∞ –ë—é–¥–∂–µ—Ç:</span> <span id="money-display" style="color:#f1c40f; font-size:14px">0</span></div>
        </div>
        <div class="hud-panel">
            <div class="section-title">üéí –†—É–∫–∞ (Q)</div>
            <div id="active-tool" style="text-align: center; font-size: 24px; margin-bottom:5px;"></div>
            <div style="text-align: center;">–°–µ–º—è–Ω: <span id="seed-count" style="color:#2ecc71">0</span></div>
        </div>
        <div class="hud-panel">
            <div class="section-title">üì¶ –£—Ä–æ–∂–∞–π</div>
            <div id="inventory-list" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="message-area"></div>

    <!-- SHOP -->
    <div id="shop-modal" style="display:none;">
        <div class="shop-header">üìà –ë–ò–†–ñ–ê –ö–£–õ–¨–¢–£–†</div>
        <div class="shop-tabs">
            <button class="shop-tab active" onclick="game.switchTab('buy')">–ö–£–ü–ò–¢–¨ –°–ï–ú–ï–ù–ê</button>
            <button class="shop-tab" onclick="game.switchTab('sell')">–°–î–ê–¢–¨ –£–†–û–ñ–ê–ô</button>
        </div>
        <div id="shop-scroll-area">
            <div id="shop-content" class="shop-grid"></div>
        </div>
        <div style="margin-top:10px; text-align:center;">
             <button id="buy-field-btn" class="shop-btn" style="background:#3498db; border-color:#2980b9; font-size:12px; padding:10px;" onclick="game.buyField()">–ö—É–ø–∏—Ç—å –ó–µ–º–ª—é (100)</button>
        </div>
        <button class="close-btn" onclick="game.toggleShop()">–ó–ê–ö–†–´–¢–¨ (E)</button>
    </div>

<script>

/* --- –î–ê–ù–ù–´–ï –ò–ì–†–´ --- */
const CROPS = {
    // TIER 1
    wheat: { n:'–ü—à–µ–Ω–∏—Ü–∞', i:'üåæ', p:5, m:2.0, t:3000 },
    clover: { n:'–ö–ª–µ–≤–µ—Ä', i:'‚òòÔ∏è', p:6, m:2.1, t:3500 },
    rice: { n:'–†–∏—Å', i:'üçö', p:7, m:2.2, t:4000 },
    grass: { n:'–¢—Ä–∞–≤–∞', i:'üåø', p:4, m:1.8, t:2000 },
    // TIER 2
    carrot: { n:'–ú–æ—Ä–∫–æ–≤—å', i:'ü•ï', p:15, m:2.5, t:6000 },
    potato: { n:'–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å', i:'ü•î', p:18, m:2.6, t:7000 },
    cucumber: { n:'–û–≥—É—Ä–µ—Ü', i:'ü•í', p:20, m:2.7, t:7500 },
    onion: { n:'–õ—É–∫', i:'üßÖ', p:22, m:2.8, t:8000 },
    corn: { n:'–ö—É–∫—É—Ä—É–∑–∞', i:'üåΩ', p:30, m:3.2, t:10000 },
    // TIER 3
    broccoli: { n:'–ë—Ä–æ–∫–∫–æ–ª–∏', i:'ü•¶', p:35, m:3.3, t:11000 },
    salad: { n:'–°–∞–ª–∞—Ç', i:'ü•¨', p:32, m:3.1, t:10500 },
    pepper: { n:'–ü–µ—Ä–µ—Ü', i:'üå∂Ô∏è', p:40, m:3.5, t:12000 },
    // TIER 4
    beet: { n:'–°–≤–µ–∫–ª–∞', i:'üü•', p:50, m:3.7, t:14000 },
    sweetpotato: { n:'–ë–∞—Ç–∞—Ç', i:'üç†', p:55, m:3.8, t:15000 },
    // TIER 5
    tomato: { n:'–¢–æ–º–∞—Ç', i:'üçÖ', p:70, m:4.2, t:18000 },
    eggplant: { n:'–ë–∞–∫–ª–∞–∂–∞–Ω', i:'üçÜ', p:75, m:4.3, t:19000 },
    strawberry: { n:'–ö–ª—É–±–Ω–∏–∫–∞', i:'üçì', p:80, m:4.5, t:20000 },
    // TIER 6
    grapes: { n:'–í–∏–Ω–æ–≥—Ä–∞–¥', i:'üçá', p:100, m:5.0, t:25000 },
    melon: { n:'–î—ã–Ω—è', i:'üçà', p:110, m:5.2, t:27000 },
    watermelon: { n:'–ê—Ä–±—É–∑', i:'üçâ', p:120, m:5.5, t:30000 },
    lemon: { n:'–õ–∏–º–æ–Ω', i:'üçã', p:140, m:6.0, t:35000 },
    banana: { n:'–ë–∞–Ω–∞–Ω', i:'üçå', p:150, m:6.2, t:37000 },
    pineapple: { n:'–ê–Ω–∞–Ω–∞—Å', i:'üçç', p:160, m:6.5, t:40000 },
    // TIER 7
    mango: { n:'–ú–∞–Ω–≥–æ', i:'ü•≠', p:200, m:7.0, t:45000 },
    apple: { n:'–Ø–±–ª–æ–∫–æ', i:'üçé', p:180, m:6.8, t:42000 },
    greenapple: { n:'–Ø–±–ª–æ–∫–æ –ó.', i:'üçè', p:185, m:6.9, t:43000 },
    kiwi: { n:'–ö–∏–≤–∏', i:'ü•ù', p:220, m:7.5, t:50000 },
    coconut: { n:'–ö–æ–∫–æ—Å', i:'ü••', p:250, m:8.0, t:55000 },
    // TIER 8
    mushroom: { n:'–ì—Ä–∏–±', i:'üçÑ', p:300, m:9.0, t:60000 },
    chestnut: { n:'–ö–∞—à—Ç–∞–Ω', i:'üå∞', p:320, m:9.5, t:65000 },
    avocado: { n:'–ê–≤–æ–∫–∞–¥–æ', i:'ü•ë', p:350, m:10.0, t:70000 },
    pumpkin: { n:'–¢—ã–∫–≤–∞', i:'üéÉ', p:400, m:11.0, t:80000 },
    // TIER 9
    bamboo: { n:'–ë–∞–º–±—É–∫', i:'üéç', p:500, m:12.0, t:90000 },
    hibiscus: { n:'–ì–∏–±–∏—Å–∫—É—Å', i:'üå∫', p:600, m:13.0, t:100000 },
    sunflower: { n:'–ü–æ–¥—Å–æ–ª–Ω—É—Ö', i:'üåª', p:700, m:14.0, t:110000 },
    rose: { n:'–†–æ–∑–∞', i:'üåπ', p:800, m:15.0, t:120000 },
    tree: { n:'–ï–ª–∫–∞', i:'üå≤', p:1000, m:20.0, t:150000 }
};

const CROP_KEYS = Object.keys(CROPS);

/* --- –°–ò–°–¢–ï–ú–ê –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø –°–ü–†–ê–ô–¢–û–í (–ì–õ–ê–í–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø) --- */
const spriteCache = {};

function getSprite(emoji, size) {
    // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è —ç–º–æ–¥–∑–∏ –∏ —Ä–∞–∑–º–µ—Ä–∞
    const key = emoji + '_' + size;
    if (spriteCache[key]) return spriteCache[key];

    // –ï—Å–ª–∏ –Ω–µ—Ç –≤ –∫—ç—à–µ, —Ä–∏—Å—É–µ–º –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–æ–º –∫–∞–Ω–≤–∞—Å–µ
    const canvas = document.createElement('canvas');
    const padding = size * 0.5; // –ó–∞–ø–∞—Å, —á—Ç–æ–±—ã –Ω–µ –æ–±—Ä–µ–∑–∞—Ç—å –∫—Ä–∞—è
    canvas.width = size + padding;
    canvas.height = size + padding;
    const ctx = canvas.getContext('2d');

    ctx.font = `${size}px serif`; // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(emoji, canvas.width/2, canvas.height/2);

    spriteCache[key] = canvas;
    return canvas;
}

class Animal {
    constructor(type, x, y) {
        this.type = type;
        this.x = x; this.y = y;
        this.size = type === 'wolf' ? 45 : (type === 'cow' ? 50 : 35);
        this.vx = 0; this.vy = 0;

        if(type==='wolf') this.emoji = 'üê∫';
        else if(type==='pig') this.emoji = 'üêñ';
        else if(type==='cow') this.emoji = 'üêÑ';
        else if(type==='chicken') this.emoji = 'üêì';

        this.target = null;
        this.dead = false;
    }

    update(animals, game) {
        if (this.dead) return;
        if (Math.random() < 0.02) {
            this.vx = (Math.random() - 0.5) * 1.5;
            this.vy = (Math.random() - 0.5) * 1.5;
        }

        if (this.type === 'wolf') {
            if (!this.target || this.target.dead) {
                let minDist = 500;
                let potential = null;
                // –ü—Ä–æ—Å—Ç–æ–π –ø–µ—Ä–µ–±–æ—Ä
                for (let a of animals) {
                    if (a !== this && a.type !== 'wolf' && !a.dead) {
                        let dx = a.x - this.x;
                        let dy = a.y - this.y;
                        // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ (–±–µ–∑ –∫–æ—Ä–Ω—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω–æ)
                        if (Math.abs(dx) < 500 && Math.abs(dy) < 500) {
                            let d = Math.hypot(dx, dy);
                            if (d < minDist) { minDist = d; potential = a; }
                        }
                    }
                }
                this.target = potential;
            }

            if (this.target && !this.target.dead) {
                let dx = this.target.x - this.x;
                let dy = this.target.y - this.y;
                let dist = Math.hypot(dx, dy);

                if (dist < 20) {
                    this.target.die(game);
                    this.target = null;
                } else {
                    this.vx = (dx / dist) * 2.8;
                    this.vy = (dy / dist) * 2.8;
                }
            }
        } else {
            // –£–±–µ–≥–∞–Ω–∏–µ
            // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ—Ö –≤–æ–ª–∫–æ–≤, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ —Ä—è–¥–æ–º
            let panic = false;
            for (let a of animals) {
                if (a.type === 'wolf') {
                     let dx = this.x - a.x;
                     let dy = this.y - a.y;
                     if (Math.abs(dx) < 250 && Math.abs(dy) < 250) { // AABB pre-check
                         let d = Math.hypot(dx, dy);
                         if (d < 250) {
                             this.vx = (dx / d) * 3.5;
                             this.vy = (dy / d) * 3.5;
                             panic = true;
                             break;
                         }
                     }
                }
            }
        }

        this.x += this.vx;
        this.y += this.vy;
        this.x = Math.max(20, Math.min(this.x, 2480));
        this.y = Math.max(20, Math.min(this.y, 1980));
    }

    die(game) {
        this.dead = true;
        this.emoji = 'üíÄ';
        game.popup("–ö—Ç–æ-—Ç–æ –±—ã–ª —Å—ä–µ–¥–µ–Ω...", '#e74c3c');
        setTimeout(() => game.respawnAnimal(this.type), 3000);
    }
}

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d', { alpha: false }); // –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ñ–æ–Ω–∞ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É –ü–ï–†–ï–î resize, —Ç–∞–∫ –∫–∞–∫ resize –∏—Å–ø–æ–ª—å–∑—É–µ—Ç this.camera
        this.camera = { x: 0, y: 0, w: 0, h: 0 };

        this.resize();

        this.running = false;
        this.money = 150;
        this.fields = [];
        this.animals = [];
        this.flora = [];

        this.seeds = {};
        this.inventory = {};
        this.boughtCounts = {};
        this.soldCounts = {};

        CROP_KEYS.forEach(k => {
            this.seeds[k] = 0; this.inventory[k] = 0;
            this.boughtCounts[k] = 0; this.soldCounts[k] = 0;
        });

        this.seeds['wheat'] = 5;

        this.player = { x: 1250, y: 1000, seedIdx: 0 };
        this.shop = { x: 1150, y: 800, open: false, tab: 'buy' };

        this.addField(this.player.x - 30, this.player.y + 60);
        this.generateWorld();

        this.keys = {};
        window.onkeydown = e => {
            this.keys[e.code] = true;
            if (e.code === 'Escape') this.toggleMenu();
            if (!this.running) return;
            if (e.code === 'KeyE') this.interactShop();
            if (e.code === 'Space') this.interactField();
            if (e.code === 'KeyQ') this.cycleSeed();
        };
        window.onkeyup = e => this.keys[e.code] = false;
        window.onresize = () => this.resize();

        // FPS counter
        this.frameCount = 0;
        this.lastTime = 0;

        this.updateUI();
        this.loop(0);
    }

    generateWorld() {
        for(let i=0; i<400; i++) {
            let type = Math.random()>0.5 ? ['üå≤','üå≥','üå¥'] : ['üåª','üå∑','üåπ','üåº'];
            let em = type[Math.floor(Math.random()*type.length)];
            this.flora.push({ e: em, x: Math.random()*2500, y: Math.random()*2000, s: 40+Math.random()*40 });
        }
        for(let i=0; i<20; i++) this.animals.push(new Animal('pig', Math.random()*2500, Math.random()*2000));
        for(let i=0; i<20; i++) this.animals.push(new Animal('chicken', Math.random()*2500, Math.random()*2000));
        for(let i=0; i<10; i++) this.animals.push(new Animal('cow', Math.random()*2500, Math.random()*2000));
        for(let i=0; i<6; i++) this.animals.push(new Animal('wolf', Math.random()*2500, Math.random()*2000));
        this.flora = this.flora.filter(f => Math.hypot(f.x - this.player.x, f.y - this.player.y) > 300);
    }

    respawnAnimal(type) {
        let x, y, d;
        do {
            x = Math.random() * 2500; y = Math.random() * 2000;
            d = Math.hypot(x - this.player.x, y - this.player.y);
        } while (d < 800);
        this.animals = this.animals.filter(a => !(a.type === type && a.dead));
        this.animals.push(new Animal(type, x, y));
    }

    startGame() {
        this.running = true;
        document.getElementById('main-menu').style.display = 'none';
    }

    toggleMenu() {
        this.running = !this.running;
        document.getElementById('main-menu').style.display = this.running ? 'none' : 'flex';
        document.querySelector('#main-menu h1').innerText = this.running ? "" : "–ü–ê–£–ó–ê";
        document.querySelector('#main-menu button').innerText = "–ü–†–û–î–û–õ–ñ–ò–¢–¨";
    }

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
        this.camera.w = this.canvas.width;
        this.camera.h = this.canvas.height;
    }

    // --- –≠–ö–û–ù–û–ú–ò–ö–ê ---
    getBuyPrice(k) {
        let base = CROPS[k].p;
        let inflation = 1 + (this.boughtCounts[k] * 0.05);
        return Math.floor(base * inflation);
    }
    getSellPrice(k) {
        let base = Math.floor(CROPS[k].p * CROPS[k].m);
        let saturation = 1 + (this.soldCounts[k] * 0.02);
        let price = Math.floor(base / saturation);
        return Math.max(1, price);
    }

    buySeed(k) {
        let p = this.getBuyPrice(k);
        if (this.money >= p) {
            this.money -= p;
            this.seeds[k]++;
            this.boughtCounts[k]++;
            this.updateShop();
            this.updateUI();
        } else {
            this.popup("–ù–µ—Ç –¥–µ–Ω–µ–≥!", '#e74c3c');
        }
    }

    sellCrop(k) {
        let count = this.inventory[k];
        if (count > 0) {
            let unitPrice = this.getSellPrice(k);
            let total = count * unitPrice;
            this.money += total;
            this.inventory[k] = 0;
            this.soldCounts[k] += count;
            this.popup(`–ü—Ä–æ–¥–∞–Ω–æ –∑–∞ ${total}`, '#f1c40f');
            this.updateShop();
            this.updateUI();
        }
    }

    addField(x, y) {
        let tiles = [];
        for(let i=0; i<2; i++) for(let j=0; j<3; j++) tiles.push({ rx:i, ry:j, c:null });
        this.fields.push({ x, y, w:2, h:3, tiles });
        this.flora = this.flora.filter(f => !(f.x > x && f.x < x+120 && f.y > y && f.y < y+180));
    }

    buyField() {
        let cost = 100 * this.fields.length;
        if(this.money >= cost) {
            this.money -= cost;
            let last = this.fields[this.fields.length-1];
            let nx = last.x + 140; let ny = last.y;
            if(nx > 2400) { nx = this.fields[0].x; ny += 200; }
            this.addField(nx, ny);
            this.updateShop();
            this.updateUI();
        } else this.popup("–ú–∞–ª–æ –¥–µ–Ω–µ–≥", '#e74c3c');
    }

    cycleSeed() {
        this.player.seedIdx = (this.player.seedIdx + 1) % CROP_KEYS.length;
        this.updateUI();
    }

    interactField() {
        if(this.shop.open) return;
        let px = this.player.x; let py = this.player.y;
        for(let f of this.fields) {
            if(px < f.x || px > f.x+120 || py < f.y || py > f.y+180) continue; // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            for(let t of f.tiles) {
                let tx = f.x + t.rx*60; let ty = f.y + t.ry*60;
                if(px > tx && px < tx+60 && py > ty && py < ty+60) {
                    if(t.c && t.c.r) {
                        this.inventory[t.c.k]++;
                        this.popup(`+1 ${CROPS[t.c.k].i}`, '#2ecc71');
                        t.c = null;
                        this.updateUI();
                    } else if(!t.c) {
                        let k = CROP_KEYS[this.player.seedIdx];
                        if(this.seeds[k] > 0) {
                            this.seeds[k]--;
                            t.c = { k: k, start: Date.now(), r: false };
                            this.popup("–ü–æ—Å–∞–∂–µ–Ω–æ", '#fff');
                            this.updateUI();
                        } else this.popup("–ù–µ—Ç —Å–µ–º—è–Ω!", '#e74c3c');
                    }
                    return;
                }
            }
        }
    }

    loop(timestamp) {
        // FPS counter
        if (timestamp - this.lastTime >= 1000) {
            document.getElementById('fps-meter').innerText = `FPS: ${this.frameCount}`;
            this.frameCount = 0;
            this.lastTime = timestamp;
        }
        this.frameCount++;

        if(this.running) {
            let speed = 6;
            if(this.keys['KeyW'] || this.keys['ArrowUp']) this.player.y -= speed;
            if(this.keys['KeyS'] || this.keys['ArrowDown']) this.player.y += speed;
            if(this.keys['KeyA'] || this.keys['ArrowLeft']) this.player.x -= speed;
            if(this.keys['KeyD'] || this.keys['ArrowRight']) this.player.x += speed;
            this.player.x = Math.max(0, Math.min(this.player.x, 2500));
            this.player.y = Math.max(0, Math.min(this.player.y, 2000));

            // Camera follow
            this.camera.x = Math.max(0, Math.min(this.player.x - this.canvas.width/2, 2500 - this.canvas.width));
            this.camera.y = Math.max(0, Math.min(this.player.y - this.canvas.height/2, 2000 - this.canvas.height));

            let now = Date.now();
            this.fields.forEach(f => f.tiles.forEach(t => {
                if(t.c && !t.c.r && now - t.c.start > CROPS[t.c.k].t) t.c.r = true;
            }));

            this.animals.forEach(a => a.update(this.animals, this));
        }

        this.draw();
        requestAnimationFrame(t => this.loop(t));
    }

    // –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –û–¢–†–ò–°–û–í–©–ò–ö
    draw() {
        // 1. –ó–∞–ª–∏–≤–∫–∞ —Å–ø–ª–æ—à–Ω—ã–º —Ü–≤–µ—Ç–æ–º (–±—ã—Å—Ç—Ä–æ)
        this.ctx.fillStyle = '#2ecc71';
        this.ctx.fillRect(0,0,this.canvas.width, this.canvas.height);

        // –°–¥–≤–∏–≥ –∫–∞–º–µ—Ä—ã
        const cx = this.camera.x;
        const cy = this.camera.y;
        const cw = this.camera.w;
        const ch = this.camera.h;

        // –†–∏—Å—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –≤–∏–¥–∏–º (CULLING) + –°–ø—Ä–∞–π—Ç—ã (CACHING)

        // –ì—Ä–∞–Ω–∏—Ü—ã –º–∏—Ä–∞ (–µ—Å–ª–∏ –≤ –∫–∞–¥—Ä–µ)
        if (cx < 10 || cy < 10 || cx > 2490 - cw || cy > 1990 - ch) {
            this.ctx.save();
            this.ctx.translate(-cx, -cy);
            this.ctx.strokeStyle = 'rgba(255,255,255,0.3)';
            this.ctx.lineWidth = 10;
            this.ctx.strokeRect(0,0,2500,2000);
            this.ctx.restore();
        }

        // –§–ª–æ—Ä–∞
        for (let f of this.flora) {
            // Culling
            if (f.x + 50 < cx || f.x - 50 > cx + cw || f.y + 50 < cy || f.y - 50 > cy + ch) continue;
            // Draw cached sprite
            let s = getSprite(f.e, Math.floor(f.s));
            this.ctx.drawImage(s, f.x - s.width/2 - cx, f.y - s.height/2 - cy);
        }

        // –ü–æ–ª—è
        for (let f of this.fields) {
            if (f.x + 150 < cx || f.x - 30 > cx + cw || f.y + 200 < cy || f.y - 30 > cy + ch) continue;

            let screenX = f.x - cx;
            let screenY = f.y - cy;

            this.ctx.fillStyle = '#5d4037';
            this.ctx.fillRect(screenX, screenY, 120, 180);
            this.ctx.strokeStyle = 'rgba(0,0,0,0.2)';
            this.ctx.strokeRect(screenX, screenY, 120, 180);

            for (let t of f.tiles) {
                let tx = screenX + t.rx * 60;
                let ty = screenY + t.ry * 60;
                this.ctx.strokeRect(tx, ty, 60, 60);

                if(t.c) {
                    let icon = t.c.r ? CROPS[t.c.k].i : 'üå±';
                    let size = t.c.r ? 40 : 25;
                    // –ê–Ω–∏–º–∞—Ü–∏—é —Å—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∏–¥–∏–º—ã—Ö
                    let bounce = (t.c.r && this.running) ? Math.sin(Date.now()/300)*3 : 0;

                    let s = getSprite(icon, size);
                    this.ctx.drawImage(s, tx + 30 - s.width/2, ty + 30 - s.height/2 + bounce);
                }
            }
        }

        // –ú–∞–≥–∞–∑–∏–Ω
        if (this.shop.x + 100 > cx && this.shop.x - 100 < cx + cw && this.shop.y + 100 > cy && this.shop.y - 100 < cy + ch) {
            let s = getSprite('üè™', 80);
            this.ctx.drawImage(s, this.shop.x - s.width/2 - cx, this.shop.y - s.height/2 - cy);
            this.ctx.fillStyle='white'; this.ctx.font='12px sans-serif'; this.ctx.textAlign='center';
            this.ctx.fillText('–ú–ê–ì–ê–ó–ò–ù', this.shop.x - cx, this.shop.y - 50 - cy);
        }

        // –ñ–∏–≤–æ—Ç–Ω—ã–µ
        for (let a of this.animals) {
            if (a.x + 60 < cx || a.x - 60 > cx + cw || a.y + 60 < cy || a.y - 60 > cy + ch) continue;

            let jump = this.running && !a.dead ? Math.abs(Math.sin(Date.now()/200 + a.x))*5 : 0;
            let s = getSprite(a.emoji, a.size);

            let drawX = a.x - cx;
            let drawY = a.y - jump - cy;

            if (a.vx < 0) {
                this.ctx.save();
                this.ctx.translate(drawX, drawY);
                this.ctx.scale(-1, 1);
                this.ctx.drawImage(s, -s.width/2, -s.height/2);
                this.ctx.restore();
            } else {
                this.ctx.drawImage(s, drawX - s.width/2, drawY - s.height/2);
            }
        }

        // –ì–µ—Ä–æ–π
        let bob = this.running && (this.keys['KeyW']||this.keys['KeyA']||this.keys['KeyS']||this.keys['KeyD']) ? Math.sin(Date.now()/100)*3 : 0;
        let hs = getSprite('ü§†', 50);
        this.ctx.drawImage(hs, this.player.x - hs.width/2 - cx, this.player.y - hs.height/2 - bob - cy);

        // –ü—Ä–∏—Ü–µ–ª (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–ª–∏–∑–∫–æ)
        let px = this.player.x; let py = this.player.y;
        for(let f of this.fields) {
            if(px < f.x || px > f.x+120 || py < f.y || py > f.y+180) continue;
            for(let t of f.tiles) {
                let tx = f.x + t.rx*60; let ty = f.y + t.ry*60;
                if(px>tx && px<tx+60 && py>ty && py<ty+60) {
                    this.ctx.strokeStyle = 'white'; this.ctx.lineWidth=3;
                    this.ctx.strokeRect(tx - cx, ty - cy, 60, 60);
                }
            }
        }
    }

    // --- UI ---
    popup(t, c) {
        let el = document.getElementById('message-area');
        el.innerText = t; el.style.color = c;
        el.style.opacity = 1; el.style.top = '10%';
        setTimeout(() => { el.style.opacity=0; el.style.top='15%'; }, 1500);
    }

    interactShop() {
        if(Math.hypot(this.player.x-this.shop.x, this.player.y-this.shop.y) < 150) this.toggleShop();
    }
    toggleShop() {
        this.shop.open = !this.shop.open;
        document.getElementById('shop-modal').style.display = this.shop.open ? 'flex' : 'none';
        if(this.shop.open) this.updateShop();
    }
    switchTab(t) {
        this.shop.tab = t;
        document.querySelectorAll('.shop-tab').forEach(b => b.classList.remove('active'));
        let idx = t === 'buy' ? 0 : 1;
        document.querySelectorAll('.shop-tab')[idx].classList.add('active');
        this.updateShop();
    }
    updateUI() {
        document.getElementById('money-display').innerText = this.money;
        let k = CROP_KEYS[this.player.seedIdx];
        document.getElementById('active-tool').innerText = CROPS[k].i + ' ' + CROPS[k].n;
        document.getElementById('seed-count').innerText = this.seeds[k];
        let inv = '';
        CROP_KEYS.forEach(key => {
            if(this.inventory[key]>0) inv += `<div class="inv-row"><span>${CROPS[key].i} ${CROPS[key].n}</span> <span>x${this.inventory[key]}</span></div>`;
        });
        document.getElementById('inventory-list').innerHTML = inv || '<div style="text-align:center; color:#777">–ü—É—Å—Ç–æ</div>';
    }
    updateShop() {
        let c = document.getElementById('shop-content'); c.innerHTML = '';
        if(this.shop.tab === 'buy') {
            CROP_KEYS.forEach(k => {
                let p = this.getBuyPrice(k);
                let div = document.createElement('div'); div.className='shop-item';
                div.innerHTML = `
                    <div style="font-size:24px">${CROPS[k].i}</div>
                    <b>${CROPS[k].n}</b>
                    <div class="price-tag">${p} üí∞</div>
                    <div style="color:#777">–†–æ—Å—Ç: ${CROPS[k].t/1000}—Å</div>
                    <button class="shop-btn" onclick="game.buySeed('${k}')">–ö–£–ü–ò–¢–¨</button>
                `;
                c.appendChild(div);
            });
        } else {
            CROP_KEYS.forEach(k => {
                let count = this.inventory[k];
                let unit = this.getSellPrice(k);
                let div = document.createElement('div'); div.className='shop-item';
                div.innerHTML = `
                    <div style="font-size:24px">${CROPS[k].i}</div>
                    <b>${CROPS[k].n}</b>
                    <div>–£ –≤–∞—Å: ${count}</div>
                    <div class="profit-tag">–¶–µ–Ω–∞: ${unit}</div>
                    <button class="shop-btn sell-btn" ${count===0?'disabled':''} onclick="game.sellCrop('${k}')">–ü–†–û–î–ê–¢–¨ –í–°–ï</button>
                `;
                c.appendChild(div);
            });
        }
        let cost = 100 * this.fields.length;
        document.getElementById('buy-field-btn').innerText = `–ö–£–ü–ò–¢–¨ –ó–ï–ú–õ–Æ (${cost})`;
    }
}

const game = new Game();

</script>
</body>
</html>