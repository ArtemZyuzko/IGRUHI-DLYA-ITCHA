<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–µ—Ä–æ–π-–§–µ—Ä–º–µ—Ä: Grand Economy</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #2ecc71;
            font-family: 'Press Start 2P', cursive;
            color: white;
            user-select: none;
        }

        canvas { display: block; cursor: crosshair; }

        /* UI */
        #ui-layer {
            position: absolute;
            top: 10px; left: 10px;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 320px;
            z-index: 5;
        }

        .hud-panel {
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid #fff;
            padding: 12px;
            border-radius: 10px;
            font-size: 10px;
            color: #fff;
            backdrop-filter: blur(4px);
        }

        .section-title {
            border-bottom: 2px solid #555;
            margin-bottom: 8px;
            padding-bottom: 4px;
            color: #f1c40f;
            text-align: center;
        }

        .inv-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            font-size: 10px;
        }

        /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é */
        #main-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 200; color: white; text-align: center;
            backdrop-filter: blur(5px);
        }

        #main-menu h1 { font-size: 40px; color: #f1c40f; margin-bottom: 10px; text-shadow: 4px 4px 0 #d35400; }
        .menu-btn {
            padding: 15px 40px; font-size: 20px; background: #27ae60;
            border: none; border-bottom: 5px solid #1e8449; color: white;
            font-family: inherit; cursor: pointer; border-radius: 8px; margin-top: 20px;
        }
        .menu-btn:hover { filter: brightness(1.1); transform: translateY(-2px); }

        /* –ú–∞–≥–∞–∑–∏–Ω */
        #shop-modal {
            display: none;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #fff; border: 8px solid #2c3e50;
            color: #333; padding: 15px; width: 800px; height: 80vh;
            border-radius: 15px; z-index: 10;
            display: flex; flex-direction: column;
        }

        .shop-header { text-align: center; margin-bottom: 10px; font-size: 16px; }

        .shop-tabs { display: flex; gap: 5px; margin-bottom: 10px; flex-shrink: 0; }
        .shop-tab {
            flex: 1; background: #ecf0f1; border: none; padding: 10px;
            cursor: pointer; font-family: inherit; font-size: 10px;
            border-bottom: 4px solid #bdc3c7;
        }
        .shop-tab.active { background: #2c3e50; color: #fff; border-bottom: 4px solid #000; }

        #shop-scroll-area {
            flex: 1; overflow-y: auto; padding-right: 5px;
        }

        .shop-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;
        }

        .shop-item {
            background: #fdfdfd; border: 1px solid #ccc;
            padding: 8px; text-align: center; font-size: 9px;
            border-radius: 6px; display: flex; flex-direction: column;
            justify-content: space-between; height: 140px;
        }

        .price-tag { color: #e74c3c; font-weight: bold; }
        .profit-tag { color: #27ae60; font-weight: bold; }

        .shop-btn {
            margin-top: auto; background: #27ae60; color: white;
            border: none; border-bottom: 3px solid #1e8449;
            padding: 6px; cursor: pointer; font-family: inherit; width: 100%; font-size: 8px;
        }
        .shop-btn:disabled { background: #95a5a6; border-color: #7f8c8d; cursor: not-allowed; }
        .sell-btn { background: #e67e22; border-color: #d35400; }

        .close-btn {
            background: #c0392b; color: white; border: none;
            border-bottom: 4px solid #922b21; padding: 10px;
            width: 100%; margin-top: 10px; cursor: pointer; font-family: inherit; flex-shrink: 0;
        }

        #message-area {
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
            font-size: 20px; font-weight: bold; text-shadow: 2px 2px 0 #000;
            pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 100;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <!-- MENU -->
    <div id="main-menu">
        <h1>üåç –ì–ï–†–û–ô-–§–ï–†–ú–ï–†</h1>
        <h2 style="color:#2ecc71; font-size:14px;">ULTIMATE ECONOMY</h2>
        <div style="font-size:10px; max-width: 600px; line-height:1.5; color:#ccc; margin-bottom:20px;">
            –≠–ö–û–ù–û–ú–ò–ö–ê –ñ–ò–í–ê–Ø: –ß–µ–º –±–æ–ª—å—à–µ –≤—ã –ø–æ–∫—É–ø–∞–µ—Ç–µ —Å–µ–º–µ–Ω–∞, —Ç–µ–º –æ–Ω–∏ –î–û–†–û–ñ–ï.<br>
            –ß–µ–º –±–æ–ª—å—à–µ –ø—Ä–æ–¥–∞–µ—Ç–µ —É—Ä–æ–∂–∞–π, —Ç–µ–º –æ–Ω –î–ï–®–ï–í–õ–ï.<br>
            –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ ‚Äî –∫–ª—é—á –∫ —É—Å–ø–µ—Ö—É!<br>
            –û—Å—Ç–æ—Ä–æ–∂–Ω–æ: –í–æ–ª–∫–∏ –≥–æ–ª–æ–¥–Ω—ã.
        </div>
        <button class="menu-btn" onclick="game.startGame()">–ù–ê–ß–ê–¢–¨</button>
    </div>

    <!-- UI -->
    <div id="ui-layer">
        <div class="hud-panel">
            <div class="inv-row"><span style="font-size:14px">üí∞ –ë—é–¥–∂–µ—Ç:</span> <span id="money-display" style="color:#f1c40f; font-size:14px">0</span></div>
        </div>
        <div class="hud-panel">
            <div class="section-title">üéí –†—É–∫–∞ (Q)</div>
            <div id="active-tool" style="text-align: center; font-size: 24px; margin-bottom:5px;"></div>
            <div style="text-align: center;">–°–µ–º—è–Ω: <span id="seed-count" style="color:#2ecc71">0</span></div>
            <div style="text-align: center; font-size:8px; color:#aaa; margin-top:2px;">–¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ —Ä–∞—Å—Ç–µ—Ç!</div>
        </div>
        <div class="hud-panel">
            <div class="section-title">üì¶ –£—Ä–æ–∂–∞–π</div>
            <div id="inventory-list" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <div id="message-area"></div>

    <!-- SHOP -->
    <div id="shop-modal" style="display:none;">
        <div class="shop-header">üìà –ë–ò–†–ñ–ê –ö–£–õ–¨–¢–£–†</div>
        <div class="shop-tabs">
            <button class="shop-tab active" onclick="game.switchTab('buy')">–ö–£–ü–ò–¢–¨ –°–ï–ú–ï–ù–ê</button>
            <button class="shop-tab" onclick="game.switchTab('sell')">–°–î–ê–¢–¨ –£–†–û–ñ–ê–ô</button>
        </div>
        <div id="shop-scroll-area">
            <div id="shop-content" class="shop-grid"></div>
        </div>
        <div style="margin-top:10px; text-align:center;">
             <button id="buy-field-btn" class="shop-btn" style="background:#3498db; border-color:#2980b9; font-size:12px; padding:10px;" onclick="game.buyField()">–ö—É–ø–∏—Ç—å –ó–µ–º–ª—é (100)</button>
        </div>
        <button class="close-btn" onclick="game.toggleShop()">–ó–ê–ö–†–´–¢–¨ (E)</button>
    </div>

<script>

/* --- 50+ –ö–£–õ–¨–¢–£–† --- */
// Base Price: –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ —Å–µ–º–µ–Ω–∏
// Growth: –í—Ä–µ–º—è —Ä–æ—Å—Ç–∞ (–º—Å)
// Value Multiplier: –í–æ —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø—Ä–æ–¥–∞–∂–∞ –¥–æ—Ä–æ–∂–µ –±–∞–∑—ã (–¥–æ –∏–Ω—Ñ–ª—è—Ü–∏–∏)
// –í—Å–µ —Ü–µ–Ω—ã —Å—Ç–∞—Ä—Ç—É—é—Ç –Ω–∏–∑–∫–æ, –Ω–æ —Ä–∞—Å—Ç—É—Ç –æ—Ç —Å–ø—Ä–æ—Å–∞!
const CROPS = {
    // TIER 1: –°—Ç–∞—Ä—Ç–æ–≤—ã–µ (–ë—ã—Å—Ç—Ä—ã–µ, –¥–µ—à–µ–≤—ã–µ)
    wheat: { n:'–ü—à–µ–Ω–∏—Ü–∞', i:'üåæ', p:5, m:2.0, t:3000 },
    clover: { n:'–ö–ª–µ–≤–µ—Ä', i:'‚òòÔ∏è', p:6, m:2.1, t:3500 },
    rice: { n:'–†–∏—Å', i:'üçö', p:7, m:2.2, t:4000 },
    grass: { n:'–¢—Ä–∞–≤–∞', i:'üåø', p:4, m:1.8, t:2000 },

    // TIER 2: –ü—Ä–æ—Å—Ç—ã–µ –æ–≤–æ—â–∏
    carrot: { n:'–ú–æ—Ä–∫–æ–≤—å', i:'ü•ï', p:15, m:2.5, t:6000 },
    potato: { n:'–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å', i:'ü•î', p:18, m:2.6, t:7000 },
    cucumber: { n:'–û–≥—É—Ä–µ—Ü', i:'ü•í', p:20, m:2.7, t:7500 },
    onion: { n:'–õ—É–∫', i:'üßÖ', p:22, m:2.8, t:8000 },
    garlic: { n:'–ß–µ—Å–Ω–æ–∫', i:'üßÑ', p:25, m:3.0, t:8500 },
    corn: { n:'–ö—É–∫—É—Ä—É–∑–∞', i:'üåΩ', p:30, m:3.2, t:10000 },

    // TIER 3: –ó–µ–ª–µ–Ω—å –∏ –°–ø–µ—Ü–∏–∏
    broccoli: { n:'–ë—Ä–æ–∫–∫–æ–ª–∏', i:'ü•¶', p:35, m:3.3, t:11000 },
    salad: { n:'–°–∞–ª–∞—Ç', i:'ü•¨', p:32, m:3.1, t:10500 },
    pepper: { n:'–ü–µ—Ä–µ—Ü', i:'üå∂Ô∏è', p:40, m:3.5, t:12000 },
    bellpepper: { n:'–ü–∞–ø—Ä–∏–∫–∞', i:'ü´ë', p:45, m:3.6, t:13000 },
    herb: { n:'–¢—Ä–∞–≤—ã', i:'üçÉ', p:28, m:2.9, t:9000 },

    // TIER 4: –ö–æ—Ä–Ω–µ–ø–ª–æ–¥—ã –∏ –ø—Ä–æ—á–µ–µ
    beet: { n:'–°–≤–µ–∫–ª–∞', i:'üü•', p:50, m:3.7, t:14000 }, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–≤–∞–¥—Ä–∞—Ç –∫–∞–∫ –∑–∞–≥–ª—É—à–∫—É —Ü–≤–µ—Ç–∞
    sweetpotato: { n:'–ë–∞—Ç–∞—Ç', i:'üç†', p:55, m:3.8, t:15000 },
    peanut: { n:'–ê—Ä–∞—Ö–∏—Å', i:'ü•ú', p:60, m:4.0, t:16000 },
    bean: { n:'–§–∞—Å–æ–ª—å', i:'ü´ò', p:65, m:4.1, t:17000 },

    // TIER 5: –Ø–≥–æ–¥—ã –∏ –ø—Ä–æ—Å—Ç—ã–µ —Ñ—Ä—É–∫—Ç—ã
    tomato: { n:'–¢–æ–º–∞—Ç', i:'üçÖ', p:70, m:4.2, t:18000 },
    eggplant: { n:'–ë–∞–∫–ª–∞–∂–∞–Ω', i:'üçÜ', p:75, m:4.3, t:19000 },
    strawberry: { n:'–ö–ª—É–±–Ω–∏–∫–∞', i:'üçì', p:80, m:4.5, t:20000 },
    cherry: { n:'–í–∏—à–Ω—è', i:'üçí', p:85, m:4.6, t:21000 },
    blueberry: { n:'–ß–µ—Ä–Ω–∏–∫–∞', i:'ü´ê', p:90, m:4.7, t:22000 },

    // TIER 6: –§—Ä—É–∫—Ç—ã (–î–æ–ª–≥–∏–µ, –¥–æ—Ä–æ–≥–∏–µ)
    grapes: { n:'–í–∏–Ω–æ–≥—Ä–∞–¥', i:'üçá', p:100, m:5.0, t:25000 },
    melon: { n:'–î—ã–Ω—è', i:'üçà', p:110, m:5.2, t:27000 },
    watermelon: { n:'–ê—Ä–±—É–∑', i:'üçâ', p:120, m:5.5, t:30000 },
    tangerine: { n:'–ú–∞–Ω–¥–∞—Ä–∏–Ω', i:'üçä', p:130, m:5.7, t:32000 },
    lemon: { n:'–õ–∏–º–æ–Ω', i:'üçã', p:140, m:6.0, t:35000 },
    banana: { n:'–ë–∞–Ω–∞–Ω', i:'üçå', p:150, m:6.2, t:37000 },
    pineapple: { n:'–ê–Ω–∞–Ω–∞—Å', i:'üçç', p:160, m:6.5, t:40000 },

    // TIER 7: –≠–∫–∑–æ—Ç–∏–∫–∞
    mango: { n:'–ú–∞–Ω–≥–æ', i:'ü•≠', p:200, m:7.0, t:45000 },
    apple: { n:'–Ø–±–ª–æ–∫–æ', i:'üçé', p:180, m:6.8, t:42000 },
    greenapple: { n:'–Ø–±–ª–æ–∫–æ –ó.', i:'üçè', p:185, m:6.9, t:43000 },
    pear: { n:'–ì—Ä—É—à–∞', i:'üçê', p:190, m:7.0, t:44000 },
    peach: { n:'–ü–µ—Ä—Å–∏–∫', i:'üçë', p:210, m:7.2, t:47000 },
    kiwi: { n:'–ö–∏–≤–∏', i:'ü•ù', p:220, m:7.5, t:50000 },
    coconut: { n:'–ö–æ–∫–æ—Å', i:'ü••', p:250, m:8.0, t:55000 },

    // TIER 8: –≠–ª–∏—Ç–∞
    mushroom: { n:'–ì—Ä–∏–±', i:'üçÑ', p:300, m:9.0, t:60000 },
    chestnut: { n:'–ö–∞—à—Ç–∞–Ω', i:'üå∞', p:320, m:9.5, t:65000 },
    avocado: { n:'–ê–≤–æ–∫–∞–¥–æ', i:'ü•ë', p:350, m:10.0, t:70000 },
    olive: { n:'–û–ª–∏–≤–∫–∞', i:'ü´í', p:380, m:10.5, t:75000 },
    pumpkin: { n:'–¢—ã–∫–≤–∞', i:'üéÉ', p:400, m:11.0, t:80000 },

    // TIER 9: –°–æ–∫—Ä–æ–≤–∏—â–∞
    bamboo: { n:'–ë–∞–º–±—É–∫', i:'üéç', p:500, m:12.0, t:90000 },
    hibiscus: { n:'–ì–∏–±–∏—Å–∫—É—Å', i:'üå∫', p:600, m:13.0, t:100000 },
    sunflower: { n:'–ü–æ–¥—Å–æ–ª–Ω—É—Ö', i:'üåª', p:700, m:14.0, t:110000 },
    rose: { n:'–†–æ–∑–∞', i:'üåπ', p:800, m:15.0, t:120000 },
    tree: { n:'–ï–ª–∫–∞', i:'üå≤', p:1000, m:20.0, t:150000 }
};

const CROP_KEYS = Object.keys(CROPS);
const EMOJIS = { hero: 'ü§†', shop: 'üè™', ground: '#2ecc71', soil: '#5d4037', sprout: 'üå±' };

/* --- –ö–õ–ê–°–°–´ --- */

class Animal {
    constructor(type, x, y) {
        this.type = type;
        this.x = x; this.y = y;
        this.size = type === 'wolf' ? 45 : (type === 'cow' ? 50 : 35);
        this.vx = 0; this.vy = 0;

        // Emojis
        if(type==='wolf') this.emoji = 'üê∫';
        else if(type==='pig') this.emoji = 'üêñ';
        else if(type==='cow') this.emoji = 'üêÑ';
        else if(type==='chicken') this.emoji = 'üêì';

        this.target = null;
        this.dead = false;
        this.deathTimer = 0;
    }

    update(animals, game) {
        if (this.dead) return;

        // Random wander
        if (Math.random() < 0.02) {
            this.vx = (Math.random() - 0.5) * 1.5;
            this.vy = (Math.random() - 0.5) * 1.5;
        }

        // --- –õ–û–ì–ò–ö–ê –í–û–õ–ö–ê ---
        if (this.type === 'wolf') {
            if (!this.target || this.target.dead) {
                let minDist = 500;
                let potential = null;
                animals.forEach(a => {
                    if (a !== this && a.type !== 'wolf' && !a.dead) {
                        let d = Math.hypot(a.x - this.x, a.y - this.y);
                        if (d < minDist) { minDist = d; potential = a; }
                    }
                });
                this.target = potential;
            }

            if (this.target && !this.target.dead) {
                let dx = this.target.x - this.x;
                let dy = this.target.y - this.y;
                let dist = Math.hypot(dx, dy);

                // –ê–¢–ê–ö–ê
                if (dist < 20) {
                    this.target.die(game); // –£–ë–ò–ô–°–¢–í–û
                    this.target = null;
                } else {
                    this.vx = (dx / dist) * 2.8; // –í–æ–ª–∫ –¥–æ–≤–æ–ª—å–Ω–æ –±—ã—Å—Ç—Ä
                    this.vy = (dy / dist) * 2.8;
                }
            }
        } else {
            // --- –õ–û–ì–ò–ö–ê –ñ–ï–†–¢–í–´ ---
            // –£–±–µ–≥–∞—Ç—å –æ—Ç –≤–æ–ª–∫–∞
            let closestWolf = null;
            let minDist = 250;
            animals.forEach(a => {
                if (a.type === 'wolf') {
                    let d = Math.hypot(a.x - this.x, a.y - this.y);
                    if (d < minDist) { minDist = d; closestWolf = a; }
                }
            });

            if (closestWolf) {
                let dx = this.x - closestWolf.x;
                let dy = this.y - closestWolf.y;
                let dist = Math.hypot(dx, dy);
                // –ñ–µ—Ä—Ç–≤–∞ –±–µ–∂–∏—Ç —á—É—Ç—å –±—ã—Å—Ç—Ä–µ–µ –≤–æ–ª–∫–∞ –≤ —Ä—ã–≤–∫–µ (—à–∞–Ω—Å —Å–ø–∞—Å—Ç–∏—Å—å)
                this.vx = (dx / dist) * 3.5;
                this.vy = (dy / dist) * 3.5;
            }
        }

        this.x += this.vx;
        this.y += this.vy;

        // –ì—Ä–∞–Ω–∏—Ü—ã
        this.x = Math.max(20, Math.min(this.x, 2500 - 20));
        this.y = Math.max(20, Math.min(this.y, 2000 - 20));
    }

    die(game) {
        this.dead = true;
        this.emoji = 'üíÄ';
        game.popup("–ö—Ç–æ-—Ç–æ –±—ã–ª —Å—ä–µ–¥–µ–Ω...", '#e74c3c');

        // –†–µ—Å–ø–∞—É–Ω —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            game.respawnAnimal(this.type);
        }, 3000);
    }
}

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.resize();

        this.running = false;
        this.money = 150; // –ß—É—Ç—å –±–æ–ª—å—à–µ –¥–µ–Ω–µ–≥ –Ω–∞ —Å—Ç–∞—Ä—Ç –¥–ª—è —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤
        this.fields = [];
        this.animals = [];
        this.flora = [];

        // –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å
        this.seeds = {};
        this.inventory = {};

        // --- –≠–ö–û–ù–û–ú–ò–ö–ê ---
        // –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –∫—É–ø–∏–ª–∏ (–ø–æ–≤—ã—à–∞–µ—Ç —Ü–µ–Ω—É)
        this.boughtCounts = {};
        // –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –ø—Ä–æ–¥–∞–ª–∏ (–ø–æ–Ω–∏–∂–∞–µ—Ç —Ü–µ–Ω—É –ø—Ä–æ–¥–∞–∂–∏)
        this.soldCounts = {};

        CROP_KEYS.forEach(k => {
            this.seeds[k] = 0;
            this.inventory[k] = 0;
            this.boughtCounts[k] = 0;
            this.soldCounts[k] = 0;
        });

        // –°—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä
        this.seeds['wheat'] = 5;

        this.player = { x: 1250, y: 1000, seedIdx: 0 };
        this.camera = { x: 0, y: 0 };
        this.shop = { x: 1150, y: 800, open: false, tab: 'buy' };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–∏—Ä–∞
        this.addField(this.player.x - 30, this.player.y + 60);
        this.generateWorld();

        // Input
        this.keys = {};
        window.onkeydown = e => {
            this.keys[e.code] = true;
            if (e.code === 'Escape') this.toggleMenu();
            if (!this.running) return;
            if (e.code === 'KeyE') this.interactShop();
            if (e.code === 'Space') this.interactField();
            if (e.code === 'KeyQ') this.cycleSeed();
        };
        window.onkeyup = e => this.keys[e.code] = false;
        window.onresize = () => this.resize();

        this.updateUI();
        this.loop();
    }

    generateWorld() {
        // –†–∞—Å—Ç–µ–Ω–∏—è
        for(let i=0; i<400; i++) {
            let type = Math.random()>0.5 ? ['üå≤','üå≥','üå¥'] : ['üåª','üå∑','üåπ','üåº'];
            let em = type[Math.floor(Math.random()*type.length)];
            this.flora.push({ e: em, x: Math.random()*2500, y: Math.random()*2000, s: 40+Math.random()*40 });
        }
        // –ñ–∏–≤–æ—Ç–Ω—ã–µ
        for(let i=0; i<20; i++) this.animals.push(new Animal('pig', Math.random()*2500, Math.random()*2000));
        for(let i=0; i<20; i++) this.animals.push(new Animal('chicken', Math.random()*2500, Math.random()*2000));
        for(let i=0; i<10; i++) this.animals.push(new Animal('cow', Math.random()*2500, Math.random()*2000));
        for(let i=0; i<6; i++) this.animals.push(new Animal('wolf', Math.random()*2500, Math.random()*2000));

        // –û—á–∏—Å—Ç–∫–∞ —Å–ø–∞–≤–Ω–∞
        this.flora = this.flora.filter(f => Math.hypot(f.x - this.player.x, f.y - this.player.y) > 300);
    }

    respawnAnimal(type) {
        // –°–ø–∞–≤–Ω–∏–º –¥–∞–ª–µ–∫–æ –æ—Ç –∏–≥—Ä–æ–∫–∞
        let x, y, d;
        do {
            x = Math.random() * 2500;
            y = Math.random() * 2000;
            d = Math.hypot(x - this.player.x, y - this.player.y);
        } while (d < 800); // –ú–∏–Ω–∏–º—É–º 800 –ø–∏–∫—Å–µ–ª–µ–π –æ—Ç –∏–≥—Ä–æ–∫–∞

        // –£–¥–∞–ª—è–µ–º —Ç—Ä—É–ø—ã —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ (–æ—á–∏—Å—Ç–∫–∞ –º–∞—Å—Å–∏–≤–∞)
        this.animals = this.animals.filter(a => !(a.type === type && a.dead));
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–≥–æ
        this.animals.push(new Animal(type, x, y));
    }

    startGame() {
        this.running = true;
        document.getElementById('main-menu').style.display = 'none';
    }

    toggleMenu() {
        this.running = !this.running;
        document.getElementById('main-menu').style.display = this.running ? 'none' : 'flex';
        document.querySelector('#main-menu h1').innerText = this.running ? "" : "–ü–ê–£–ó–ê";
        document.querySelector('#main-menu button').innerText = "–ü–†–û–î–û–õ–ñ–ò–¢–¨";
    }

    resize() {
        this.canvas.width = window.innerWidth;
        this.canvas.height = window.innerHeight;
    }

    // --- –≠–ö–û–ù–û–ú–ò–ö–ê ---

    // –¶–µ–Ω–∞ –ø–æ–∫—É–ø–∫–∏ —Ä–∞—Å—Ç–µ—Ç –Ω–∞ 5% –∑–∞ –∫–∞–∂–¥—É—é –ø–æ–∫—É–ø–∫—É —ç—Ç–æ–≥–æ –≤–∏–¥–∞
    getBuyPrice(k) {
        let base = CROPS[k].p;
        let inflation = 1 + (this.boughtCounts[k] * 0.05);
        return Math.floor(base * inflation);
    }

    // –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ –ø–∞–¥–∞–µ—Ç –Ω–∞ 2% –∑–∞ –∫–∞–∂–¥—É—é –ø—Ä–æ–¥–∞–∂—É (–¥–µ—Ñ–ª—è—Ü–∏—è —Å–ø—Ä–æ—Å–∞)
    getSellPrice(k) {
        let base = Math.floor(CROPS[k].p * CROPS[k].m);
        let saturation = 1 + (this.soldCounts[k] * 0.02);
        let price = Math.floor(base / saturation);
        return Math.max(1, price); // –ú–∏–Ω–∏–º—É–º 1 –º–æ–Ω–µ—Ç–∞
    }

    buySeed(k) {
        let p = this.getBuyPrice(k);
        if (this.money >= p) {
            this.money -= p;
            this.seeds[k]++;
            this.boughtCounts[k]++; // –ò–Ω—Ñ–ª—è—Ü–∏—è!
            this.updateShop();
            this.updateUI();
        } else {
            this.popup("–ù–µ—Ç –¥–µ–Ω–µ–≥!", '#e74c3c');
        }
    }

    sellCrop(k) {
        let count = this.inventory[k];
        if (count > 0) {
            let unitPrice = this.getSellPrice(k);
            let total = count * unitPrice;
            this.money += total;
            this.inventory[k] = 0;
            this.soldCounts[k] += count; // –†—ã–Ω–æ–∫ –Ω–∞—Å—ã—â–∞–µ—Ç—Å—è, —Ü–µ–Ω–∞ –ø–∞–¥–∞–µ—Ç
            this.popup(`–ü—Ä–æ–¥–∞–Ω–æ –∑–∞ ${total}`, '#f1c40f');
            this.updateShop();
            this.updateUI();
        }
    }

    // --- GAMEPLAY ---

    addField(x, y) {
        let tiles = [];
        for(let i=0; i<2; i++) for(let j=0; j<3; j++) tiles.push({ rx:i, ry:j, c:null });
        this.fields.push({ x, y, w:2, h:3, tiles });
        // –†—É–±–∫–∞ –¥–µ—Ä–µ–≤—å–µ–≤
        this.flora = this.flora.filter(f => !(f.x > x && f.x < x+120 && f.y > y && f.y < y+180));
    }

    buyField() {
        let cost = 100 * this.fields.length;
        if(this.money >= cost) {
            this.money -= cost;
            let last = this.fields[this.fields.length-1];
            let nx = last.x + 140; let ny = last.y;
            if(nx > 2400) { nx = this.fields[0].x; ny += 200; }
            this.addField(nx, ny);
            this.updateShop();
            this.updateUI();
        } else this.popup("–ú–∞–ª–æ –¥–µ–Ω–µ–≥", '#e74c3c');
    }

    cycleSeed() {
        this.player.seedIdx = (this.player.seedIdx + 1) % CROP_KEYS.length;
        this.updateUI();
    }

    interactField() {
        if(this.shop.open) return;
        let px = this.player.x; let py = this.player.y;

        for(let f of this.fields) {
            for(let t of f.tiles) {
                let tx = f.x + t.rx*60; let ty = f.y + t.ry*60;
                if(px > tx && px < tx+60 && py > ty && py < ty+60) {
                    if(t.c && t.c.r) {
                        // –°–±–æ—Ä
                        this.inventory[t.c.k]++;
                        this.popup(`+1 ${CROPS[t.c.k].i}`, '#2ecc71');
                        t.c = null;
                        this.updateUI();
                    } else if(!t.c) {
                        // –ü–æ—Å–∞–¥–∫–∞
                        let k = CROP_KEYS[this.player.seedIdx];
                        if(this.seeds[k] > 0) {
                            this.seeds[k]--;
                            t.c = { k: k, start: Date.now(), r: false };
                            this.popup("–ü–æ—Å–∞–∂–µ–Ω–æ", '#fff');
                            this.updateUI();
                        } else this.popup("–ù–µ—Ç —Å–µ–º—è–Ω!", '#e74c3c');
                    }
                }
            }
        }
    }

    // --- UPDATE & DRAW ---

    loop() {
        if(this.running) {
            // Player Move
            let speed = 6;
            if(this.keys['KeyW'] || this.keys['ArrowUp']) this.player.y -= speed;
            if(this.keys['KeyS'] || this.keys['ArrowDown']) this.player.y += speed;
            if(this.keys['KeyA'] || this.keys['ArrowLeft']) this.player.x -= speed;
            if(this.keys['KeyD'] || this.keys['ArrowRight']) this.player.x += speed;
            this.player.x = Math.max(0, Math.min(this.player.x, 2500));
            this.player.y = Math.max(0, Math.min(this.player.y, 2000));

            // Camera
            this.camera.x = Math.max(0, Math.min(this.player.x - this.canvas.width/2, 2500 - this.canvas.width));
            this.camera.y = Math.max(0, Math.min(this.player.y - this.canvas.height/2, 2000 - this.canvas.height));

            // Crops
            let now = Date.now();
            this.fields.forEach(f => f.tiles.forEach(t => {
                if(t.c && !t.c.r && now - t.c.start > CROPS[t.c.k].t) t.c.r = true;
            }));

            // Animals
            this.animals.forEach(a => a.update(this.animals, this));
            // –£–¥–∞–ª—è–µ–º "–æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ –º–µ—Ä—Ç–≤—ã—Ö" (—á—å–µ –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Å–º–µ—Ä—Ç–∏ –≤—ã—à–ª–æ), —Ö–æ—Ç—è —Ä–µ—Å–ø–∞—É–Ω –¥–µ–ª–∞–µ—Ç —ç—Ç–æ —Ç–æ–∂–µ
        }

        this.draw();
        requestAnimationFrame(() => this.loop());
    }

    draw() {
        this.ctx.fillStyle = '#2ecc71';
        this.ctx.fillRect(0,0,this.canvas.width, this.canvas.height);
        this.ctx.save();
        this.ctx.translate(-this.camera.x, -this.camera.y);

        // –ì—Ä–∞–Ω–∏—Ü–∞
        this.ctx.strokeStyle = 'rgba(255,255,255,0.3)';
        this.ctx.lineWidth = 10;
        this.ctx.strokeRect(0,0,2500,2000);

        // –§–ª–æ—Ä–∞
        this.flora.forEach(f => {
            this.ctx.font = `${f.s}px serif`;
            this.ctx.textAlign='center'; this.ctx.textBaseline='middle';
            this.ctx.fillText(f.e, f.x, f.y);
        });

        // –ü–æ–ª—è
        this.fields.forEach(f => {
            this.ctx.fillStyle = '#5d4037';
            this.ctx.fillRect(f.x, f.y, 120, 180);
            this.ctx.strokeStyle = 'rgba(0,0,0,0.2)';
            this.ctx.strokeRect(f.x, f.y, 120, 180);
            f.tiles.forEach(t => {
                let tx = f.x + t.rx*60; let ty = f.y + t.ry*60;
                this.ctx.strokeRect(tx, ty, 60, 60);
                if(t.c) {
                    let icon = t.c.r ? CROPS[t.c.k].i : 'üå±';
                    let size = t.c.r ? 40 : 25;
                    let bounce = t.c.r && this.running ? Math.sin(Date.now()/300)*3 : 0;
                    this.ctx.font = `${size}px serif`;
                    this.ctx.fillText(icon, tx+30, ty+30+bounce);
                }
            });
        });

        // –ú–∞–≥–∞–∑–∏–Ω
        this.ctx.font = '80px serif';
        this.ctx.fillText('üè™', this.shop.x, this.shop.y);
        this.ctx.fillStyle='white'; this.ctx.font='12px sans-serif';
        this.ctx.fillText('–ú–ê–ì–ê–ó–ò–ù', this.shop.x, this.shop.y-50);

        // –ñ–∏–≤–æ—Ç–Ω—ã–µ
        this.animals.forEach(a => {
            let jump = this.running && !a.dead ? Math.abs(Math.sin(Date.now()/200 + a.x))*5 : 0;
            this.ctx.font = `${a.size}px serif`;
            this.ctx.save();
            this.ctx.translate(a.x, a.y - jump);
            if(a.vx < 0) this.ctx.scale(-1, 1);
            this.ctx.fillText(a.emoji, 0, 0);
            this.ctx.restore();
        });

        // –ì–µ—Ä–æ–π
        let bob = this.running && (this.keys['KeyW']||this.keys['KeyA']||this.keys['KeyS']||this.keys['KeyD']) ? Math.sin(Date.now()/100)*3 : 0;
        this.ctx.font = '50px serif';
        this.ctx.fillText('ü§†', this.player.x, this.player.y - bob);

        // –ü—Ä–∏—Ü–µ–ª
        let cx = this.player.x; let cy = this.player.y;
        this.fields.forEach(f => f.tiles.forEach(t => {
            let tx = f.x + t.rx*60; let ty = f.y + t.ry*60;
            if(cx>tx && cx<tx+60 && cy>ty && cy<ty+60) {
                this.ctx.strokeStyle = 'white'; this.ctx.lineWidth=3;
                this.ctx.strokeRect(tx, ty, 60, 60);
            }
        }));

        this.ctx.restore();
    }

    // --- UI HELPERS ---
    popup(t, c) {
        let el = document.getElementById('message-area');
        el.innerText = t; el.style.color = c;
        el.style.opacity = 1; el.style.top = '10%';
        setTimeout(() => { el.style.opacity=0; el.style.top='15%'; }, 1500);
    }

    interactShop() {
        if(Math.hypot(this.player.x-this.shop.x, this.player.y-this.shop.y) < 150) this.toggleShop();
    }
    toggleShop() {
        this.shop.open = !this.shop.open;
        document.getElementById('shop-modal').style.display = this.shop.open ? 'flex' : 'none';
        if(this.shop.open) this.updateShop();
    }
    switchTab(t) {
        this.shop.tab = t;
        document.querySelectorAll('.shop-tab').forEach(b => b.classList.remove('active'));
        let idx = t === 'buy' ? 0 : 1;
        document.querySelectorAll('.shop-tab')[idx].classList.add('active');
        this.updateShop();
    }
    updateUI() {
        document.getElementById('money-display').innerText = this.money;
        let k = CROP_KEYS[this.player.seedIdx];
        document.getElementById('active-tool').innerText = CROPS[k].i + ' ' + CROPS[k].n;
        document.getElementById('seed-count').innerText = this.seeds[k];
        let inv = '';
        CROP_KEYS.forEach(key => {
            if(this.inventory[key]>0) inv += `<div class="inv-row"><span>${CROPS[key].i} ${CROPS[key].n}</span> <span>x${this.inventory[key]}</span></div>`;
        });
        document.getElementById('inventory-list').innerHTML = inv || '<div style="text-align:center; color:#777">–ü—É—Å—Ç–æ</div>';
    }
    updateShop() {
        let c = document.getElementById('shop-content'); c.innerHTML = '';
        if(this.shop.tab === 'buy') {
            CROP_KEYS.forEach(k => {
                let p = this.getBuyPrice(k);
                let div = document.createElement('div'); div.className='shop-item';
                div.innerHTML = `
                    <div style="font-size:24px">${CROPS[k].i}</div>
                    <b>${CROPS[k].n}</b>
                    <div class="price-tag">${p} üí∞</div>
                    <div style="color:#777">–†–æ—Å—Ç: ${CROPS[k].t/1000}—Å</div>
                    <button class="shop-btn" onclick="game.buySeed('${k}')">–ö–£–ü–ò–¢–¨</button>
                `;
                c.appendChild(div);
            });
        } else {
            CROP_KEYS.forEach(k => {
                let count = this.inventory[k];
                let unit = this.getSellPrice(k);
                let div = document.createElement('div'); div.className='shop-item';
                div.innerHTML = `
                    <div style="font-size:24px">${CROPS[k].i}</div>
                    <b>${CROPS[k].n}</b>
                    <div>–£ –≤–∞—Å: ${count}</div>
                    <div class="profit-tag">–¶–µ–Ω–∞: ${unit}</div>
                    <button class="shop-btn sell-btn" ${count===0?'disabled':''} onclick="game.sellCrop('${k}')">–ü–†–û–î–ê–¢–¨ –í–°–ï</button>
                `;
                c.appendChild(div);
            });
        }
        let cost = 100 * this.fields.length;
        document.getElementById('buy-field-btn').innerText = `–ö–£–ü–ò–¢–¨ –ó–ï–ú–õ–Æ (${cost})`;
    }
}

const game = new Game();

</script>
</body>
</html>
